## 1 PC Register介绍



![image-20220603004653039](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/589/image-20220603004653039.png)

​		JVM中的程序计数寄存器(Program Counter Register)中，Register的命令源于CPU的寄存器，寄存器存储指令的线程信息。CPU只有把数据装载到寄存器才能够运行。

​		这里，并非是指广义上所指的物理寄存器，获取将其翻译为PC计数器(或指令计数器)会更加贴切(也称为程序钩子)，并且也不容易引起一些不必要的误会。<font color='red'>JVM中PC寄存器是对物理PC寄存器的一种抽象模拟</font>。

### 作用：

PC寄存器用来存储指令指向<font color='red'>下一条指令的地址</font>，也即将要执行的指令代码。由执行引擎读取下一条指令。

![image-20220603005205351](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/589/image-20220603005205351.png)

- 它是一块很小的内存空间，几乎可以忽略不记。也是运行速度最快的存储区域。
- 在JVM规范中，每个线程都有它自己的程序计数器，是线程私有的，生命周期与线程的生命周期保持一致。
- 任何时间一个线程都只有一个方法在执行，也就是所谓的<font color='red'>当前方法</font>。程序计数器会存储当前线程正在执行的Java方法的JVM指令地址：或者，如果是在执行native方法，则是未指定值(undefined)
- 它是程序控制流的指示器，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计算器来完成。
- 字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令。
- 它是唯一一个在Java虚拟机规范中没有规定任何OutOtMemoryError情况的区域。

## 2 举例说明

```java
public class PCRegisterTest {
  public static void main(String[] args) {
    int i = 10;
    int j = 20;
    int k = i + j;

    String s = "abd";
    System.out.println(i);
    System.out.println(k);
  }
}
```

反编译：

```java
javap -v PCRegisterTest.class
```

反编译后结果：

![image-20220603112942541](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/589/image-20220603112942541.png)

## 3 两个常见问题

### **使用PC寄存器存储字节码指令地址有什么用呢？**

### **为什么使用PC寄存器记录当前线程的执行地址？**

因为CPU需要不停的切换各个线程，这时候切换回来以后，就得知道接着从哪开始继续执行。

JVM的字节码解释器就需要通过改变PC寄存器的值来明确下一条应该执行什么样的字节码指令。

![image-20220603113453390](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/589/image-20220603113453390.png)

### PC寄存器为什么会被设定为线程私有？

​		我们都知道所谓的多线程在一个特定的时间段内只会执行其中某一个线程的方法，CPU会不停地做任务切换，这样必然导致经常中断或恢复，如何保证分毫无差呢？<font color='red'>为了能够准确地记录各个线程正在执行的当前字节码指令地址，最好的办法自然是为每个线程都分配一个PC寄存器</font>,这样一来各个线程之间便可以进行独立计算，从而不会出现相互干扰的情况。

​		由于CPU时间片轮限制，众多线程在并发执行过程中，任何一个确定的时刻，一个处理器或多核处理器中的一个内核，只会执行某一个线程中的某一条指令。

​		这样必然导致经常中断或恢复，如何保证分毫误差呢？每个线程在创建后，都会产生自己的程序计数器和栈帧，程序计数器在各个线程之间互不影响。

### CPU时间片

​		CPU时间片即CPU分配给各个程序的时间，每个线程被分配一个时间段，称作它的时间片。

​		在宏观上，我们可以同时打开多个应用程序，每个程序并行不悖，同时运行。

​		但在微观上：由于只有一个CPU，一次只能处理程序要求的一部分，如何处理公平，一种方法就是引入时间片，每个程序轮流执行。

